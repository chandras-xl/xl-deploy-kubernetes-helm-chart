# XL-Deploy HA on Kubernetes Helm Chart
This repository contains a Helm Chart for Xebialabs Deploy (XL Deploy) product. The Helm Chart automates and simplifies deploying XL-Deploy clusters on Kubernetes and other Kubernetes-enabled Platforms by providing the essential features you need to keep your clusters up and running. 

## Prerequisites Details
* Kubernetes 1.18+

## Chart Details
This chart will deploy following components:
* PostgreSQL single instance / pod (**NOTE:** For production grade installations it is recommended to use an external PostgreSQL)
* RabbitMQ in highly available configuration
* HAProxy ingress controller
* XL-Deploy Multiple Master and Worker
> **Note**: Satellites are expected to be deployed outside the kubernetes cluster.

## Requirements
- A running Kubernetes cluster
	- Dynamic storage provisioning enabled
	- StorageClass for persistent storage
	- Desired StorageClass must be set to default
- [Kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl/) installed and setup to use the cluster
- [Helm](https://helm.sh/docs/intro/install/) 3 installed
- License File for XL-Deploy in Base64 Encoded format
- Repository Keystorefile in Base64 Encoded format

## Tested Configuration
**Supported Platforms:**
Kubernetes 1.18+
AWS EKS
**Storage:**
NFS
AWS EFS
**Messaging Queue:**
Rabbit MQ 
**Database:**
Postgresql 
**LoadBalancers:**
HAProxy Ingress Controller

## Installing the Chart
Before installing helm charts, you need to update the dependencies of a chart:
```bash
helm dependency update xl-deploy-kubernetes-helm-chart
```
To install the chart with the release name `xld-production`:
```bash
helm install xld-production xl-deploy-kubernetes-helm-chart
```
The [Parameters](#parameters) section lists the parameters that can be configured during installation.

## Access XL-Deploy Dashboard
NodePort service is exposed externally on the available worker nodes and can be seen by running below command
```bash
kubectl get service
```
You can access xldeploy UI from an outside cluster with NodeIP:NodePort/xl-deploy/ 
The path should be unique across the kubernetes cluster.(Ex "/xl-deploy/")
## Uninstalling the Chart
To uninstall/delete the `xld-production` deployment:
```bash
helm delete xld-production
```
The command removes all the Kubernetes components but PV and PVC's associated with the chart is not removed.
To delete the PVC's associated with `xld-production`:
```bash
kubectl delete pvc -l release=xld-production
```
> **Note**: Deleting the PVC's will delete all data. Please be cautious before doing it.

## Parameters
For deployment of Helm Chart on Production environment, all parameters need to be looked very carefully.
However, for deployment of Helm Chart on test environment, only few values of parameters need to be added and it deploys chart with all default values. The values for the parameters which need to be added are as follows:
*xldLicense*: License for XL-Deploy in base64 format
*Persistence.StorageClass*: Storage Class to be defined, NFS for OnPremise and EFS for AWS EKS
The following tables lists the configurable parameters of the XL-Deploy chart and their default values.
Parameter                                          |Description                                                                                                                                                          |Default                                                                                                                                                                                                                                                                                                                                                                        
---------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
K8sSetup.Platform                                  |Platform on which to install the chart. Allowed values are PlainK8s and AWSEKS                                                                                                                               |PlainK8s                                                                                                                                                                                                                                                                                                                                                                       
XldMasterCount                                     |Number of master replicas                                                                                                                                             |3                                                                                                                                                                                                                                                                                                                                                                              
XldWorkerCount                                     |Number of worker replicas                                                                                                                                             |3                                                                                                                                                                                                                                                                                                                                                                              
ImageRepository                                    |Image name                                                                                                                                                           |xebialabs/xl-deploy                                                                                                                                                                                                                                                                                                                                                            
ImageTag                                           |Image tag                                                                                                                                                            |9.7                                                                                                                                                                                                                                                                                                                                                                            
ImagePullPolicy                                    |Image pull policy, Defaults to 'Always' if image tag is 'latest',set to 'IfNotPresent'                                                                               |Always                                                                                                                                                                                                                                                                                                                                                                         
ImagePullSecret                                    |Specify docker-registry secret names. Secrets must be manually created in the namespace                                                                              |nil                                                                                                                                                                                                                                                                                                                                                                            
haproxy-ingress.install                            |Install haproxy subchart. If you have haproxy already installed, set 'install' to 'false'                                                                            |true                                                                                                                                                                                                                                                                                                                                                                           
haproxy-ingress.controller.kind                          |Type of deployment, DaemonSet or Deployment                                                                            |DaemonSet                                                                                                                                                                                                                                                                                                                                                                           
haproxy-ingress.controller.service.type            |Kubernetes Service type for haproxy. It can be changed to LoadBalancer or NodePort                                                                                   |NodePort                                                                                                                                                                                                                                                                                                                                                                       
ingress.Enabled                                    |Exposes HTTP and HTTPS routes from outside the cluster to services within the cluster                                                                                |true                                                                                                                                                                                                                                                                                                                                                                           
ingress.annotations                                |Annotations for ingress controller                                                                                                                                   |ingress.kubernetes.io/ssl-redirect: "false"&nbsp; &nbsp; &nbsp; kubernetes.io/ingress.class: haproxy ingress.kubernetes.io/rewrite-target: / ingress.kubernetes.io/affinity: cookie ingress.kubernetes.io/session-cookie-name: JSESSIONID ingress.kubernetes.io/session-cookie-strategy: prefix ingress.kubernetes.io/config-backend: `|`&nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; &nbsp;  option httpchk GET /ha/health HTTP/1.0
ingress.path                                       |You can route an Ingress to different Services based on the path                                                                                                     |/xl-deploy/                                                                                                                                                                                                                                                                                                                                                                    
ingress.tls                                        |The Helm chart deploys the HAProxy Kubernetes Ingress Controller with default settings, but you can override the values by configuring TLS encryption                      |false                                                                                                                                                                                                                                                                                                                                                                          
AdminPassword                                      |Admin password for xldeploy                                                                                                                                          |If user does not provide password, random 10 character alphanumeric string will be generated                                                                                                                                                                                                                                                                                                                                        
xldLicense                                         |Convert xl-deploy.lic files content to base64                                                                    |nil                                                                                                                                                                                                                                                                                                                                                                            
RepositoryKeystore                                 |Convert keystore.jks files content to base64                                                                      |nil                                                                                                                                                                                                                                                                                                                                                                            
KeystorePassphrase                                 |Passphrase for keystore.jks file                                                                                                                                     |nil                                                                                                                                                                                                                                                                                                                                                                            
resources                                          |CPU/Memory resource requests/limits. User can change the parameter accordingly                                                                                                                                  |nil                                                                                                                                                                                                                                                                                                                                                                            
postgresql.install                                 |Installs postgresql chart with single instance. If you have an existing database deployment, set 'install' to 'false'.                                                                     |true                                                                                                                                                                                                                                                                                                                                                                           
postgresql.postgresqlUsername                      |PostgreSQL user (creates a non-admin user when postgresqlUsername is not postgres)                                                                                   |postgres                                                                                                                                                                                                                                                                                                                                                                       
postgresql.postgresqlPassword                      |PostgreSQL user password                                                                                                                                             |random 10 character alphanumeric string                                                                                                                                                                                                                                                                                                                                        
postgresql.replication.enabled                     |Enable replication                                                                                                                                                   |false                                                                                                                                                                                                                                                                                                                                                                          
postgresql.postgresqlExtendedConf.listenAddresses  |Specifies the TCP/IP address(es) on which the server is to listen for connections from client applications                                                           | *                                                                                                                                                                                                                                                                                                                                                                            
postgresql.postgresqlExtendedConf.maxConnections   |Maximum total connections                                                                                                                                            |500                                                                                                                                                                                                                                                                                                                                                                            
postgresql.initdbScriptsSecret                     |Secret with initdb scripts that contain sensitive information (Note: can be used with initdbScriptsConfigMap or initdbScripts). The value is evaluated as a template.|postgresql-init-sql-xlr                                                                                                                                                                                                                                                                                                                                                        
postgresql.service.port                            |PostgreSQL port                                                                                                                                                      |5432                                                                                                                                                                                                                                                                                                                                                                           
postgresql.persistence.enabled                     |Enable persistence using PVC                                                                                                                                         |true                                                                                                                                                                                                                                                                                                                                                                           
postgresql.persistence.size                        |PVC Storage Request for PostgreSQL volume                                                                                                                            |8Gi                                                                                                                                                                                                                                                                                                                                                                            
postgresql.persistence.existingClaim               |Provide an existing PersistentVolumeClaim, the value is evaluated as a template.                                                                                     |nil                                                                                                                                                                                                                                                                                                                                                                            
postgresql.resources                               |CPU/Memory resource requests/limits                                                                                                                                  |Memory: 256Mi, CPU: 250m                                                                                                                                                                                                                                                                                                                                                       
postgresql.nodeSelector                            |Node labels for pod assignment                                                                                                                                       |{}                                                                                                                                                                                                                                                                                                                                                                             
postgresql.affinity                                |Affinity labels for pod assignment                                                                                                                                   |{}                                                                                                                                                                                                                                                                                                                                                                             
postgresql.tolerations                             |Toleration labels for pod assignment                                                                                                                                 |\[\]                                                                                                                                                                                                                                                                                                                                                                           
UseExistingDB.Enabled                              |If you want to use an existing database, change 'postgresql.install' to 'false'.                                                                                     |false                                                                                                                                                                                                                                                                                                                                                                          
UseExistingDB.XL\_DB\_URL                          |Database URL for xldeploy                                                                                                                                            |nil                                                                                                                                                                                                                                                                                                                                                                            
UseExistingDB.XL\_DB\_USERNAME                     |Database User for xldeploy                                                                                                                                           |nil                                                                                                                                                                                                                                                                                                                                                                            
UseExistingDB.XL\_DB\_PASSWORD                     |Database Password for xldeploy                                                                                                                                       |nil                                                                                                                                                                                                                                                                                                                                                                            
rabbitmq-ha.install                                |Install rabbitmq chart. If you have an existing message queue deployment, set 'install' to 'false'.                                                                  |true                                                                                                                                                                                                                                                                                                                                                                           
rabbitmq-ha.rabbitmqUsername                       |RabbitMQ application username                                                                                                                                        |guest                                                                                                                                                                                                                                                                                                                                                                          
rabbitmq-ha.rabbitmqPassword                       |RabbitMQ application password                                                                                                                                        |random 24 character long alphanumeric string                                                                                                                                                                                                                                                                                                                                   
rabbitmq-ha.extraPlugins                           |Additional plugins to add to the default configmap                                                                                                                   | rabbitmq_shovel, rabbitmq_shovel_management, rabbitmq_federation, rabbitmq_federation_management, rabbitmq_jms_topic_exchange, rabbitmq_management,                                                                                                                                                                                                   
rabbitmq-ha.replicaCount                           |Number of replica                                                                                                                                                    |3                                                                                                                                                                                                                                                                                                                                                                              
rabbitmq-ha.rbac.create                            |If true, create & use RBAC resources                                                                                                                                 |true                                                                                                                                                                                                                                                                                                                                                                           
rabbitmq-ha.service.type                           |Type of service to create                                                                                                                                            |ClusterIP                                                                                                                                                                                                                                                                                                                                                                      
rabbitmq-ha.persistentVolume.enabled               |If true, persistent volume claims are created                                                                                                                        |false                                                                                                                                                                                                                                                                                                                                                                          
rabbitmq-ha.persistentVolume.size                  |Persistent volume size                                                                                                                                               |8Gi                                                                                                                                                                                                                                                                                                                                                                            
rabbitmq-ha.persistentVolume.annotations           |Persistent volume annotations                                                                                                                                        |{}                                                                                                                                                                                                                                                                                                                                                                             
rabbitmq-ha.persistentVolume.resources             |CPU/Memory resource requests/limits                                                                                                                                  |{}                                                                                                                                                                                                                                                                                                                                                                             
rabbitmq-ha.definitions.policies                   |HA policies to add to definitions.json                                                                                                                               | `{"name": "ha-all","pattern": ".*","vhost": "/","definition": {"ha-mode": "all","ha-sync-mode": "automatic", "ha-sync-batch-size": 1 } }`                                                                                                                                                                                                      
rabbitmq-ha.definitions.globalParameters           |Pre-configured global parameters                                                                                                                                     |`{"name": "cluster_name", "value": "" }`                                                                                                                                                                                                                                                                                                                                
rabbitmq-ha.prometheus.operator.enabled            |Enabling Prometheus Operator                                                                                                                                         |false                                                                                                                                                                                                                                                                                                                                                                          
UseExistingMQ.Enabled                              |If you want to use an existing Message Queue, change 'rabbitmq-ha.install' to 'false'                                                                                |false                                                                                                                                                                                                                                                                                                                                                                          
UseExistingMQ.XLD\_TASK\_QUEUE\_USERNAME           |Username for xldeploy task queue                                                                                                                                     |nil                                                                                                                                                                                                                                                                                                                                                                            
UseExistingMQ.XLD\_TASK\_QUEUE\_PASSWORD           |Password for xldeploy task queue                                                                                                                                     |nil                                                                                                                                                                                                                                                                                                                                                                            
UseExistingMQ.XLD\_TASK\_QUEUE\_URL                |URL for xldeploy task queue                                                                                                                                          |nil                                                                                                                                                                                                                                                                                                                                                                            
UseExistingMQ.XLD\_TASK\_QUEUE\_DRIVER\_CLASS\_NAME|Driver Class Name for xldeploy task queue                                                                                                                            |nil                                                                                                                                                                                                                                                                                                                                                                            
HealthProbes                                       |Would you like a HealthProbes to be enabled                                                                                                                          |true                                                                                                                                                                                                                                                                                                                                                                           
HealthProbesLivenessTimeout                        |Delay before liveness probe is initiated                                                                                                                             |90                                                                                                                                                                                                                                                                                                                                                                             
HealthProbesReadinessTimeout                       |Delay before readiness probe is initiated                                                                                                                            |90                                                                                                                                                                                                                                                                                                                                                                             
HealthProbeFailureThreshold                        |Minimum consecutive failures for the probe to be considered failed after having succeeded                                                                            |12                                                                                                                                                                                                                                                                                                                                                                             
HealthPeriodScans                                  |How often to perform the probe                                                                                                                                       |10                                                                                                                                                                                                                                                                                                                                                                             
nodeSelector                                       |Node labels for pod assignment                                                                                                                                       |{}                                                                                                                                                                                                                                                                                                                                                                             
tolerations                                        |Toleration labels for pod assignment                                                                                                                                 |\[\]                                                                                                                                                                                                                                                                                                                                                                           
affinity                                           |Affinity labels for pod assignment                                                                                                                                   |{}                                                                                                                                                                                                                                                                                                                                                                             
Persistence.Enabled                                |Enable persistence using PVC                                                                                                                                         |true                                                                                                                                                                                                                                                                                                                                                                           
Persistence.StorageClass                           |PVC Storage Class for volume                                                                                                                                         |nil                                                                                                                                                                                                                                                                                                                                                                            
Persistence.Annotations                            |Annotations for the PVC                                                                                                                                              |{}                                                                                                                                                                                                                                                                                                                                                                             
Persistence.AccessMode                             |PVC Access Mode for volume                                                                                                                                           |ReadWriteOnce                                                                                                                                                                                                                                                                                                                                                                  
Persistence.XldExportPvcSize                                   |XLD Master PVC Storage Request for volume. For production grade setup, size must be changed                                                                                     |10Gi                                                                                                                                                                                                                                                                                                                                                                            
Persistence.XldWorkPvcSize                                   |XLD Worker PVC Storage Request for volume. For production grade setup, size must be changed                                                                                     |5Gi                                                                                                                                                                                                                                                                                                                                                                            

## Upgrading the Chart
To upgrade the version `ImageTag` parameter need to be updated to the desired version. To see the list available ImageTag for XL-Deploy see the following links [Deploy_tags](https://hub.docker.com/r/xebialabs/xl-deploy/tags).
To upgrade the chart with the release name `xld-production`:
```bash
helm upgrade xld-production xl-deploy-kubernetes-helm-chart/
```
> **Note**:
	The custom plugins are not upgraded as part of helm upgrade, as default Docker images only included with the bundled plugins. If you have a new custom plugin, or external libraries that you want to install or upgrade, the user has to create their own Docker Image. See the [Adding custom plugins](https://docs.xebialabs.com/v.9.7/deploy/how-to/customize-xl-up/#adding-custom-plugins) section in the xebialabs official documentation.
	
### Existing or External Databases
There is an option to use external PostgreSQL database for your XL-Deploy.
Configure values.yaml file accordingly.
If you want to use an existing database,  these steps need to be followed:
- Change `postgresql.install` to false
- `UseExistingDB.Enabled`: true
- `UseExistingDB.XL_DB_URL`: jdbc:postgresql://<postgres-service-name>.<namsepace>.svc.cluster.local:5432/<xld-database-name>
- `UseExistingDB.XL_DB_USERNAME`: Database User for xldeploy
- `UseExistingDB.XL_DB_PASSWORD`: Database Password for xldeploy

**Example:**
```bash
#Passing a custom PostgreSQL to XL-Deploy
UseExistingDB:
  Enabled: true
  # If you want to use existing database, change the value to "true".
  # Uncomment the following lines and provide the values.
  XL_DB_URL: jdbc:postgresql://myrelease-postgresql.default.svc.cluster.local:5432/xld-db
  XL_DB_USERNAME: postgres
  XL_DB_PASSWORD: postgres
```  
> **Note**: User might have databases instance running outside the cluster. Configure parameters accordingly.
### Existing or External Messaging Queue
There is an option to use external RabbitMQ for your XL-Deploy.
If you want to use an existing RabbitMQ,  these steps need to be followed:
- Change `rabbitmq-ha.install` to false
- `UseExistingMQ.Enabled`: true
- `UseExistingMQ.XLD_TASK_QUEUE_USERNAME`: Username for xldeploy task queue
- `UseExistingMQ.XLD_TASK_QUEUE_PASSWORD`: Password for xldeploy task queue
- `UseExistingMQ.XLD_TASK_QUEUE_URL`: Task Queue URL for xldeploy
- `UseExistingMQ.XLD_TASK_QUEUE_DRIVER_CLASS_NAME`: amqp://<rabbitmq-service-name>.<namsepace>.svc.cluster.local:5672
**Example:**
```bash
# Passing a custom RabbitMQ to XL-Deploy
UseExistingMQ:
  Enabled: true
  # If you want to use an existing Message Queue, change 'rabbitmq-ha.install' to 'false'.
  # Set 'UseExistingMQ.Enabled' to 'true'.Uncomment the following lines and provide the values.
  XLD_TASK_QUEUE_USERNAME: guest
  XLD_TASK_QUEUE_PASSWORD: guest
  XLD_TASK_QUEUE_URL: amqp://myrelease-rabbitmq-ha.default.svc.cluster.local:5672/%2F
  XLD_TASK_QUEUE_DRIVER_CLASS_NAME: amqp://myrelease-rabbitmq-ha.default.svc.cluster.local:5672
```
> **Note**: User might have rabbitmq instance running outside the cluster. Configure parameters accordingly.
### Existing Ingress Controller
There is an option to use external ingress controller for XL-Deploy.
If you want to use an existing ingress controller,  change `haproxy.install` to false.

## Useful links
- [`xebialabs/xl-deploy:<tagname>`](https://hub.docker.com/r/xebialabs/xl-deploy) – Docker Hub repository for xldeploy
- [`stable/rabbitmq-ha`](https://github.com/helm/charts/tree/master/stable/rabbitmq-ha) -  Github repository for RabbitMQ Helm Chart
- [`bitnami/postgresql`](https://github.com/bitnami/charts/tree/master/bitnami/postgresql) -  Github repository for Postgresql Helm Chart
- [`haproxy-ingress/haproxy-ingress`](https://github.com/haproxy-ingress/charts) -  Github repository for HAProxy Ingress Controller Helm Chart

